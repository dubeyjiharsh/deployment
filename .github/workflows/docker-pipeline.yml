

name: Build & Push Docker Image
on:
  push:
    branches: ["main"]
    tags:
      - "v*.*.*"   # run only on tag push
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect which folder changed
      - name: Detect changed folder
        id: detect
        run: |
          TAG=${{ github.ref_name }}
          PREV_TAG=$(git describe --tags --abbrev=0 ${TAG}^ 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          if [ -z "$PREV_TAG" ]; then
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $TAG)
          else
            CHANGED_FILES=$(git diff --name-only $PREV_TAG $TAG)
          fi
          echo "Changed files:"
          echo "$CHANGED_FILES"
          if echo "$CHANGED_FILES" | grep -q "^canvas-be/"; then
            echo "SERVICE=canvas-be" >> $GITHUB_ENV
          elif echo "$CHANGED_FILES" | grep -q "^canvas-fe/"; then
            echo "SERVICE=canvas-fe" >> $GITHUB_ENV
          else
            echo "No changes in canvas-be or canvas-fe"
            exit 1
          fi
      # Login to Docker Hub
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin
      #  Build Docker image using TAG
      - name: Build Docker image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SERVICE }}:${{ github.ref_name }} \
            ./${{ env.SERVICE }}
      # Push Docker image with SAME TAG
      - name: Push Docker image
        run: |
          docker push \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SERVICE }}:${{ github.ref_name }}
  

