<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Form Assistant</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">

</head>
<body>
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="upload-box">
            <h3>Upload</h3>
             <!-- Upload Form button -->
    <input type="file" id="formUpload" style="display: none;" onchange="handleUpload()" />
            <button class="button" onclick="document.getElementById('formUpload').click()">Upload Form</button>
            <select class="button" id="uploadedForms" onchange="handleFormSelect()">
    <option value="" disabled selected>View Uploaded Forms</option>
</select>
<button class="button" onclick="showFormAssistant()">Fill a Form</button>
        </div>
     

    </div>

    <!-- Middle Overview Section -->
    <div class="main-overview" id="overview" style="display:none;">
        <h2>Field Overview</h2>
        <p>No fields selected yet.</p>
    </div>

    <!-- Right Chat Section -->
    <div class="chat-section" id="chatSection">
    <div class="chat-messages" id="chatMessages">
        <p><strong>Bot:</strong> ðŸ‘‹ Hi there! I'm your smart form buddy â€” ready to turn your info into a perfectly filled form. Just share a few details and Iâ€™ll handle the rest! Ready to get started?</p>
    </div>

    <div class="chat-input">
        <input type="text" id="userInput" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
    </div>

    <!-- Download Button below send button -->
    <button class="download-button" id="download" onclick="downloadcsv()">Download</button>


    <script>
        function showFormAssistant() {
            const selectedForm = document.getElementById('uploadedForms').value;
            if (!selectedForm) {
                alert("Please select a form to fill.");
                return;
            }
            // Set doc_id for chat
            const doc_id = uploadedDocIds[selectedForm];
            sessionStorage.setItem('selected_doc_id', doc_id);

            document.getElementById('chatSection').style.display = 'flex';
            document.getElementById('overview').style.display = 'block';
            handleFormSelect(); // Show fields for the selected form
        }

        function viewUploadedForms() {
            alert("This would display uploaded forms. Connect to backend to load real files.");
        }

     const user_name = "{{ username }}"; // This will be replaced by Flask with the session username
     async function sendMessage() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        if (!message) return;

        const chatBox = document.getElementById('chatMessages');
        console.log(chatBox)

        const userMsg = document.createElement('div');
        userMsg.className = 'chat-message user';
        userMsg.textContent = message;
        chatBox.appendChild(userMsg);

        chatBox.scrollTop = chatBox.scrollHeight;
        input.value = '';

        try {
            const session_id = sessionStorage.getItem('session_id');
            sessionStorage.setItem('session_id', session_id);

            // Get the doc_id of the selected form from sessionStorage
            const doc_id = sessionStorage.getItem('selected_doc_id');

            const payload = {
                session_id: session_id,
                user_name: user_name, 
                user_message: message,
                confirmation: "True",
                document_id: doc_id // <-- Pass the correct doc_id
            };

            const response = await fetch('/chat', {
                method: 'POST',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            const botMsg = document.createElement('div');
            botMsg.className = 'chat-message bot';
            botMsg.textContent = data.bot_message || "No response from server.";
            chatBox.appendChild(botMsg);

            chatBox.scrollTop = chatBox.scrollHeight;

            const clean_doc_id = data.doc_id ? data.doc_id.replace(/^DOC_/, '') : '';
            if (data.BIC) {
                showFieldOverview(data.BIC, clean_doc_id);
            }

        } catch (error) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'chat-message bot';
            errorMsg.textContent = "Error contacting server.";
            chatBox.appendChild(errorMsg);
        }
    }

    function generateSessionId() {
        return 'sess_' + Math.random().toString(36).substr(2, 9);
    }


    function getBotReply(msg) {
        msg = msg.toLowerCase();
        if (msg.includes("hello") || msg.includes("hi")) return "Hello! How can I assist you today?";
        if (msg.includes("form")) return "Sure! Please select or upload a form from the left panel.";
        return "I'm here to help. Could you clarify your request?";
    }
    async function downloadcsv(){
    const user_name = "{{ username }}";
    const session_id = sessionStorage.getItem('session_id');
    const doc_id = sessionStorage.getItem('selected_doc_id');
    if (!user_name || !session_id || !doc_id) {
        alert("User or session info missing.");
        return;
    }
    try{
        
        const response = await fetch(`http://localhost:8080/download?session_id=${encodeURIComponent(session_id)}&user_name=${encodeURIComponent(user_name)}&doc_id=${encodeURIComponent(doc_id)}`, {
            method: 'GET'
        });
        if (!response.ok) {
            const errorData = await response.json();
            alert("âŒ Download failed: " + errorData.detail);
            return;
        }
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;

        // Extract filename from Content-Disposition header if present, otherwise use fallback
        const disposition = response.headers.get('Content-Disposition');
        const match = disposition && disposition.match(/filename="?([^"]+)"?/);
        const filename = match ? match[1] : `${session_id}_${user_name}_${doc_id}_form_data.csv`;

        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(downloadUrl);

    } catch (err) {
        console.error("CSV download error:", err);
        alert("âŒ Error downloading CSV: " + err.message);
    }

    }
  
</script>
      
    </script>
</body>
</html>
<script>
let uploadedFiles = [];
let uploadedDocIds = {}; // filename -> doc_id

async function handleUpload() {
    const fileInput = document.getElementById('formUpload');
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('pdf_file', file);

    const res = await fetch('/upload_form', {
        method: 'POST',
        body: formData
    });

    const result = await res.json();

    // Map filename to doc_id for later use
    uploadedFiles.push(file.name);
    uploadedDocIds[file.name] = result.doc_id;

    updateUploadedFormsDropdown();
    showFieldOverview(result.field_names, result.filename);
}

function updateUploadedFormsDropdown() {
    const dropdown = document.getElementById('uploadedForms');
    dropdown.innerHTML = '<option value="" disabled selected>View Uploaded Forms</option>';
    uploadedFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file;
        option.textContent = file;
        dropdown.appendChild(option);
    });
}

function showFieldOverview(fieldNames, fileName) {
    const overview = document.getElementById('overview');
    // If fieldNames is an object, get its keys and values
    const isObj = fieldNames && typeof fieldNames === 'object' && !Array.isArray(fieldNames);
    const keys = isObj ? Object.keys(fieldNames) : Array.isArray(fieldNames) ? fieldNames : [];
    overview.style.display = 'flex';
    const baseName = fileName ? fileName.replace(/-\w{8}(-\w{4}){3}-\w{12}\.pdf$/i, '').replace(/\.pdf$/i, '') : '';
    overview.innerHTML = `
    <h2>Form Fields${baseName ? ' - ' + baseName : ''}</h2>
    ${keys.length > 0 ? `
        <div class="fields-list">
            ${keys.map(field => `
                <div class="field-row">
                    <label class="field-label">${field}</label>
                    <input class="field-value" type="text" value="${isObj ? fieldNames[field] : ''}" readonly />
                </div>
            `).join('')}
        </div>
    ` : `<p>No fields detected in this form.</p>`}
    `;
}

async function handleFormSelect() {
    await saveChatHistory(); // Save current chat before switching

    const selectedForm = document.getElementById('uploadedForms').value;
    if (!selectedForm) return;

    // Get doc_id for this form
    const doc_id = uploadedDocIds[selectedForm];
    if (!doc_id) return;

    // Get username and session_id from template/sessionStorage
    const user_name = "{{ username }}";
    const session_id = "{{ session_id }}";
   

    // Call the /get-form-fields endpoint
    const formData = new URLSearchParams();
formData.append('user_name', user_name);
formData.append('session_id', session_id);
formData.append('document_id', doc_id);

const res = await fetch('http://127.0.0.1:8080/get-form-fields', {
    method: 'POST',
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: formData
});

    const data = await res.json();
    

    // Show the fields in the overview
    if (data.description) {
        showFieldOverview(data.fields, selectedForm);
    }
    // Retrieve chat history for this session/form
    await retrieveChatHistory();

    // Store selected doc_id for chatbot use
    sessionStorage.setItem('selected_doc_id', doc_id);
}

// Helper: Get chat history as HTML string
function getChatHistoryHTML() {
    return document.getElementById('chatMessages').innerHTML;
}

// Helper: Set chat history from HTML string
function setChatHistoryHTML(html) {
    document.getElementById('chatMessages').innerHTML = html;
}

// Save chat history for a specific doc_id (the one you're leaving)
async function saveChatHistory(doc_id) {
    const user_name = "{{ username }}";
    const session_data = getChatHistoryHTML();
    const session_id = sessionStorage.getItem('session_id');
    const timestamp = new Date().toISOString();
    await fetch('http://127.0.0.1:8080/sessions/save', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_name,
            session_id,
            document_id: doc_id,
            session_data,
            timestamp
        })
    });
}

// Retrieve chat history for a specific doc_id (the one you're switching to)
async function retrieveChatHistory(doc_id) {
    const user_name = "{{ username }}";
    const session_id = sessionStorage.getItem('session_id');
    const res = await fetch('http://127.0.0.1:8080/sessions/retrieve', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_name,
            session_id,
            document_id: doc_id
        })
    });
    const data = await res.json();
    if (data.session_data) {
        setChatHistoryHTML(data.session_data);
    } else {
            setChatHistoryHTML('<p><strong>Bot:</strong> ðŸ‘‹ Hi there! I\'m your smart form buddy â€” ready to turn your info into a perfectly filled form. Just share a few details and Iâ€™ll handle the rest! Ready to get started?</p>');
    }
}

// Main form selection handler
async function handleFormSelect() {
    // Save chat for the previous form (if any)
    const prev_doc_id = sessionStorage.getItem('selected_doc_id');
    if (prev_doc_id) {
        await saveChatHistory(prev_doc_id);
    }

    const selectedForm = document.getElementById('uploadedForms').value;
    if (!selectedForm) return;

    // Get doc_id for the newly selected form
    const doc_id = uploadedDocIds[selectedForm];
    if (!doc_id) return;

    // Call the /get-form-fields endpoint (unchanged)
    const user_name = "{{ username }}";
    const session_id = "{{ session_id }}";
    const formData = new URLSearchParams();
    formData.append('user_name', user_name);
    formData.append('session_id', session_id);
    formData.append('document_id', doc_id);

    const res = await fetch('http://127.0.0.1:8080/get-form-fields', {
        method: 'POST',
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
    });

    const data = await res.json();

    // Show the fields in the overview
    if (data.description) {
        showFieldOverview(data.fields, selectedForm);
    }

    // Update selected_doc_id to the new form
    sessionStorage.setItem('selected_doc_id', doc_id);

    // Retrieve chat history for the new form
    await retrieveChatHistory(doc_id);
}
</script>


<script>
document.getElementById('uploadForm').onsubmit = async function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/upload', {
        method: 'POST',
        body: formData
    });
    const result = await res.json();
    if (result.fields) {
        alert("Uploaded and processed!");
        loadUploadedForms(); // Refresh dropdown
        selectForm(result.filename); // Auto-show fields
    }
};
</script>

<script>
async function loadUploadedForms() {
    const res = await fetch('/list_pdfs');
    const forms = await res.json();
    const dropdown = document.getElementById('formDropdown');
    forms.forEach(form => {
        const option = document.createElement('option');
        option.value = form;
        option.textContent = form;
        dropdown.appendChild(option);
    });
}

async function selectForm(formName) {
    if (!formName) return;

    const res = await fetch(`/get_fields/${formName}`);
    const data = await res.json();

    const overview = document.getElementById('overview');
    overview.style.display = 'flex';
    overview.innerHTML = `
        <h2>Field Overview - ${formName}</h2>
        <ul>
            ${data.fields.map(field => `<li>${field}</li>`).join('')}
        </ul>
    `;
}
loadUploadedForms();
</script>
<script>
window.onload = function() {
    // Set session_id in sessionStorage from Flask template variable
    const flaskSessionId = "{{ session_id }}";
    if (flaskSessionId) {
        sessionStorage.setItem('session_id', flaskSessionId);
    }
};
</script>